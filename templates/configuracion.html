{% extends "layout.html" %}
{% block content %}

<div class="page-title mb-6 text-xl font-bold">Configuración de la Aplicación</div>
<!-- SERVIDORES -->
<div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-2xl font-bold">Servidores</h1>
    </div>

    <!-- Crear -->
    <form action="{{ url_for('configuracion.add_servidor') }}" method="POST" class="flex gap-2 items-center mb-4">
        <input type="text" name="nombre" placeholder="Nombre del servidor" required
               class="flex-1 px-3 py-2 border rounded-lg
                      bg-white dark:bg-gray-800
                      text-gray-900 dark:text-gray-100
                      border-gray-300 dark:border-gray-700">
        <input type="text" name="ruta" placeholder="http(s)://IP o URL:puerto/path" required
               class="flex-1 px-3 py-2 border rounded-lg
                      bg-white dark:bg-gray-800
                      text-gray-900 dark:text-gray-100
                      border-gray-300 dark:border-gray-700">
        <button class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
            Añadir
        </button>
    </form>

    <!-- Tabla de servidores -->
    <table class="table-auto w-full text-left mb-4">
        <thead class="border-b border-gray-300 dark:border-gray-600">
        <tr>
            <th class="px-2 py-1">Nombre</th>
            <th class="px-2 py-1">Ruta</th>
            <th class="px-2 py-1">Acciones</th>
        </tr>
        </thead>
        <tbody>
        {% for s in servidores %}
        <tr class="border-b border-gray-200 dark:border-gray-700">
            <td class="px-2 py-1">{{ s.nombre }}</td>
            <td class="px-2 py-1">{{ s.ruta }}</td>
            <td class="px-2 py-1 flex gap-2">
                <button onclick="openModalServidor('{{ s.nombre }}','{{ s.ruta }}')"
                        class="px-2 py-1 bg-green-600 text-white rounded">
                    <i class="fas fa-edit"></i>
                </button>

                <form action="{{ url_for('configuracion.delete_servidor') }}" method="POST" class="inline">
                    <input type="hidden" name="nombre" value="{{ s.nombre }}">
                    <button class="px-2 py-1 bg-red-600 text-white rounded">
                        <i class="fa-solid fa-trash"></i>
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>

<div class="grid grid-cols-2 gap-6">

    <!-- TIPOS DE TIPOS -->
    <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Tipos de Tipos</h1>
            <h3>Introduce los tipos de balizas a gestionar</h3>
        </div>

        <!-- Crear -->
        <form action="{{ url_for('configuracion.route_add_tipo') }}" method="POST" class="flex gap-2 items-center mb-4">

            <input type="text" name="nombre" placeholder="Nombre del tipo" required
                   class="flex-1 px-3 py-2 border rounded-lg
                bg-white dark:bg-gray-800
                text-gray-900 dark:text-gray-100
                border-gray-300 dark:border-gray-700">
            <input type="color" name="color" required
                   class="w-12 h-8 p-0 rounded-lg border
                bg-white dark:bg-gray-800
                border-gray-300 dark:border-gray-700">

            <button class="btn px-3 py-1 bg-blue-600 text-white rounded">Añadir</button>
        </form>

        <!-- Tabla -->
        <table class="table-auto w-full text-left mb-4">
            <thead class="border-b border-gray-300 dark:border-gray-600">
            <tr>
                <th class="px-2 py-1">Nombre</th>
                <th class="px-2 py-1">Color</th>
                <th class="px-2 py-1">Preview</th>
                <th class="px-2 py-1">Acciones</th>
            </tr>
            </thead>
            <tbody>
            {% for t in tipos_de_tipos %}
            <tr class="border-b border-gray-200 dark:border-gray-700">
                <td class="px-2 py-1">{{ t.nombre }}</td>
                <td class="px-2 py-1">{{ t.color }}</td>
                <td class="px-2 py-1">

                    <span class="badge"
                          style="background: {{ t.color }};
                            color: {{ calcular_texto(t.color) }};">
                            {{ t.nombre }}
                        </span>
                </td>
                <td class="px-2 py-1 flex gap-2">
                    <button onclick="openModal('tipo', '{{ t.nombre }}', '{{ t.color }}')"
                            class="px-2 py-1 bg-green-600 text-white rounded mr-1">
                        <i class="fas fa-edit"></i>
                    </button>

                    <form action="{{ url_for('configuracion.route_delete_tipo') }}" method="POST" class="inline">
                        <input type="hidden" name="nombre" value="{{ t.nombre }}">
                        <button class="px-2 py-1 bg-red-600 text-white rounded">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </form>
                </td>

            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- TIPOS DE EVENTOS -->
    <div class="card bg-white dark:bg-gray-800 p-4 rounded-xl shadow">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl font-bold">Tipos de Eventos</h1>
            <h3>Introduce los tipos de eventos a registrar</h3>
        </div>

        <form action="{{ url_for('configuracion.route_add_evento') }}" method="POST" class="flex gap-2 items-center mb-4">

            <input type="text" name="nombre" placeholder="Nombre del evento" required
                   class="flex-1 px-3 py-2 border rounded-lg
                    bg-white dark:bg-gray-800
                    text-gray-900 dark:text-gray-100
                    border-gray-300 dark:border-gray-700">

            <input type="color" name="color" required
                   class="w-12 h-8 p-0 rounded-lg border
                    bg-white dark:bg-gray-800
                    border-gray-300 dark:border-gray-700">

            <button class="px-3 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                Añadir
            </button>

        </form>
        <table class="table-auto w-full text-left mb-4">
            <thead class="border-b border-gray-300 dark:border-gray-600">
            <tr>
                <th class="px-2 py-1">Nombre</th>
                <th class="px-2 py-1">Color</th>
                <th class="px-2 py-1">Preview</th>
                <th class="px-2 py-1">Acciones</th>
            </tr>
            </thead>
            <tbody>
            {% for e in tipos_de_eventos %}
            <tr class="border-b border-gray-200 dark:border-gray-700">
                <td class="px-2 py-1">{{ e.nombre }}</td>
                <td class="px-2 py-1">{{ e.color }}</td>
                <td class="px-2 py-1">
                    <!--
                    <span class="badge" style="background: {{ e.color }}; color: #fff;">
                        {{ e.nombre }}
                    </span>
                    -->
                    <span class="badge"
                          style="background: {{ e.color }};
                            color: {{ calcular_texto(e.color) }};">
                            {{ e.nombre }}
                        </span>
                </td>
                <td class="px-2 py-1 flex gap-2">
                    <button onclick="openModal('evento', '{{ e.nombre }}', '{{ e.color }}')"
                            class="px-2 py-1 bg-green-600 text-white rounded mr-1">
                        <i class="fas fa-edit"></i>
                    </button>

                    <form action="{{ url_for('configuracion.route_delete_evento') }}" method="POST" class="inline">
                        <input type="hidden" name="nombre" value="{{ e.nombre }}">
                        <button class="px-2 py-1 bg-red-600 text-white rounded">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

</div>


<!-- MODAL EDICIÓN SERVIDOR -->
<div id="editServidorModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">Editar servidor</h2>

        <form id="editServidorForm" method="POST">
            <input type="hidden" name="original" id="editServidorOriginal">

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Nombre</label>
                <input type="text" id="editServidorNombre" name="nombre"
                       class="w-full px-3 py-2 border rounded-lg
                              bg-white dark:bg-gray-800
                              text-gray-900 dark:text-gray-100
                              border-gray-300 dark:border-gray-700">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Ruta</label>
                <input type="text" id="editServidorRuta" name="ruta"
                       class="w-full px-3 py-2 border rounded-lg
                              bg-white dark:bg-gray-800
                              text-gray-900 dark:text-gray-100
                              border-gray-300 dark:border-gray-700">
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeServidorModal()"
                        class="px-4 py-2 rounded-lg bg-gray-300 dark:bg-gray-600">Cancelar
                </button>
                <button type="submit"
                        class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">Guardar cambios
                </button>
            </div>
        </form>
    </div>
</div>


<!-- MODAL SERVIDOR -->
<div id="editServidorModal"
     class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">
            Editar Servidor
        </h2>

        <form id="editServidorForm" method="POST">
            <input type="hidden" name="original" id="editServidorOriginal">

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Nombre</label>
                <input type="text" id="editServidorNombre" name="nombre"
                       class="w-full px-3 py-2 border rounded-lg
                              bg-white dark:bg-gray-800
                              text-gray-900 dark:text-gray-100
                              border-gray-300 dark:border-gray-700">
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Ruta</label>
                <input type="text" id="editServidorRuta" name="ruta"
                       class="w-full px-3 py-2 border rounded-lg
                              bg-white dark:bg-gray-800
                              text-gray-900 dark:text-gray-100
                              border-gray-300 dark:border-gray-700"
                       placeholder="IP o URL:puerto/path">
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button"
                        onclick="closeServidorModal()"
                        class="px-4 py-2 rounded-lg bg-gray-300 dark:bg-gray-600">
                    Cancelar
                </button>
                <button type="submit"
                        class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
                    Guardar cambios
                </button>
            </div>
        </form>
    </div>
</div>


<!-- MODAL TIPOS / EVENTOS -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl p-6 w-full max-w-md">
        <h2 class="text-xl font-bold mb-4 text-gray-800 dark:text-gray-100">
            Editar elemento
        </h2>

        <form id="editForm" method="POST" action="">

            <input type="hidden" name="original" id="editOriginal">

            <div class="mb-4">
                <label class="block text-sm font-medium mb-1">Nombre</label>
                <input type="text" id="editNombre" name="nombre"
                       class="w-full px-3 py-2 border rounded-lg
                              bg-white dark:bg-gray-800
                              text-gray-900 dark:text-gray-100
                              border-gray-300 dark:border-gray-700">
            </div>

            <label class="block text-sm mb-1 font-medium">Color</label>

            <div class="flex flex-wrap gap-2 mb-3">
                {% set colores = [
                "#1E90FF", "#28A745", "#FFC107", "#DC3545", "#6C757D",
                "#17A2B8", "#6610F2", "#FD7E14", "#20C997", "#E83E8C", "#343A40"
                ] %}
                {% for c in colores %}
                <div onclick="setColor('{{ c }}', this)"
                     class="w-10 h-10 rounded-lg cursor-pointer border-2 border-gray-400 transition-all"
                     style="background: {{ c }}"></div>
                {% endfor %}
            </div>

            <input type="text" name="color" id="colorHex"
                   class="w-full px-3 py-2 border rounded-lg
       bg-white dark:bg-gray-800
       border-gray-300 dark:border-gray-700"
                   placeholder="#RRGGBB">


            <br>

            <div class="flex  space-x-3">
                <button type="button"
                        onclick="closeModal()"
                        class="px-4 py-2 rounded-lg bg-gray-300 dark:bg-gray-600">
                    Cancelar
                </button>

                <button type="submit"
                        class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700">
                    Guardar cambios
                </button>
            </div>

        </form>
    </div>
</div>

<!-- ********************************************************************************* -->
<!-- =============================== -->
<!-- FINGERPRINT POLICY CONFIG -->
<!-- =============================== -->
<div class="card bg-white dark:bg-gray-800 p-6 rounded-xl shadow mt-8">
    <div class="flex justify-between items-center mb-4">
        <h1 class="text-2xl font-bold">Fingerprint Correlation Policy</h1>
        <span class="text-sm text-gray-500">
            Ajuste fino del motor de correlación
        </span>
    </div>

    <form action="{{ url_for('configuracion.update_fingerprint_policy') }}"
          method="POST"
          class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- ================= -->
        <!-- CHECKS / WEIGHTS -->
        <!-- ================= -->
        <div>
            <h2 class="text-lg font-semibold mb-3">Pesos de señales</h2>

            <div class="mb-4 flex gap-3 items-center">
    <span class="text-sm font-semibold">Presets:</span>







<div class="relative group">
    <button type="button"
            onclick="applyPreset('equilibrado')"
            class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
        Equilibrado
    </button>

    <div class="absolute z-50 hidden group-hover:block
                left-1/2 -translate-x-1/2 top-full mt-2
                w-80 p-3 rounded-lg shadow-lg
                bg-gray-900 text-white text-xs">

        <div class="font-semibold mb-1">Preset equilibrado</div>

        <ul class="list-disc list-inside space-y-1">
            <li>visitorId: 40</li>
            <li>platform: 10</li>
            <li>browser: 10</li>
            <li>timezone: 10</li>
            <li>deviceMemory: 10</li>
            <li>screenResolution: 20</li>
        </ul>

        <div class="mt-2 text-gray-300">
            Enfoque equilibrado entre precisión y flexibilidad.
            Recomendado para operación SOC continua.
        </div>
    </div>
</div>







<div class="relative group">
    <button type="button"
            onclick="applyPreset('agresivo')"
            class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">
        Agresivo
    </button>

    <!-- Tooltip -->
    <div class="absolute z-50 hidden group-hover:block
                left-1/2 -translate-x-1/2 top-full mt-2
                w-72 p-3 rounded-lg shadow-lg
                bg-gray-900 text-white text-xs">

        <div class="font-semibold mb-1">Preset agresivo</div>
        <ul class="list-disc list-inside space-y-1">
            <li>visitorId: 60</li>
            <li>platform: 5</li>
            <li>browser: 5</li>
            <li>timezone: 10</li>
            <li>deviceMemory: 10</li>
            <li>screenResolution: 10</li>
        </ul>
        <div class="mt-2 text-gray-300">
            Enfoque orientado a alta correlación.
            Riesgo bajo de falsos positivos, mayor severidad.
        </div>
    </div>
</div>







<div class="relative group">
    <button type="button"
            onclick="applyPreset('relajado')"
            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
        Relajado
    </button>

    <div class="absolute z-50 hidden group-hover:block
                left-1/2 -translate-x-1/2 top-full mt-2
                w-80 p-3 rounded-lg shadow-lg
                bg-gray-900 text-white text-xs">

        <div class="font-semibold mb-1">Preset relajado</div>

        <ul class="list-disc list-inside space-y-1">
            <li>visitorId: 20</li>
            <li>platform: 15</li>
            <li>browser: 15</li>
            <li>timezone: 10</li>
            <li>deviceMemory: 10</li>
            <li>screenResolution: 30</li>
        </ul>

        <div class="mt-2 text-gray-300">
            Pensado para tracking analítico o escenarios
            con cambios frecuentes de entorno. Alta tolerancia a variaciones.
        </div>
    </div>
</div>

<!--    <button type="button"-->
<!--            id="resetPolicyBtn"-->
<!--            class="px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">-->
<!--        <i class="fa-solid fa-rotate-left"></i>-->
<!--    </button>-->
<!--            </div>-->


<!-- Botón: Reset (con tooltip) -->
<div class="relative group inline-block">
  <button
    type="button"
    id="resetPolicyBtn"
    class="px-6 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500">
    <i class="fa-solid fa-rotate-left"></i>
  </button>

  <!-- Tooltip -->
  <div class="absolute z-50 hidden group-hover:block
              left-1/2 -translate-x-1/2 top-full mt-2
              w-64 p-3 rounded-lg shadow-lg
              bg-gray-900 text-white text-xs">
    <div class="font-semibold mb-1">Restablecer política</div>
    <div class="text-gray-300">
      Restaura los valores por defecto de la política de fingerprint.
      No afecta a los datos históricos.
    </div>
  </div>
</div>
</div>

{% set check_descriptions = {
    "visitorId": "Identificador persistente del navegador. Señal más fuerte de identidad.",
    "platform": "Sistema operativo reportado por el cliente.",
    "browser": "Navegador y versión principal.",
    "timezone": "Zona horaria del sistema del usuario.",
    "deviceMemory": "Memoria RAM aproximada del dispositivo.",
    "screenResolution": "Resolución de pantalla reportada."
} %}

{% for key, weight in fingerprint_policy.checks.items() %}
<div class="grid grid-cols-[1fr_auto] gap-4 items-center mb-3">

<!--    <label class="font-mono text-sm w-48">{{ key }}</label>-->
<div class="flex flex-col max-w-md">
    <span class="font-mono text-sm">{{ key }}</span>
    <span class="text-xs text-gray-500 leading-relaxed">
        {{ check_descriptions.get(key, "") }}
    </span>
</div>


    <div class="flex items-center gap-3">
        <!-- DELTA A LA IZQUIERDA -->
        <span id="delta_{{ key }}"
              class="delta-indicator w-10 text-right font-mono text-sm font-semibold hidden">
        </span>

        <input type="number"
               name="check_{{ key }}"
               value="{{ weight }}"
               min="0"
               max="100"
               data-original="{{ weight }}"
               data-key="{{ key }}"
               class="weight-input w-24 px-2 py-1 border rounded-lg
                      bg-white dark:bg-gray-900
                      border-gray-300 dark:border-gray-700">
    </div>
</div>
{% endfor %}



            <div class="mt-4 flex items-center justify-between border-t pt-3">
                <span class="font-semibold text-sm">
                    Suma total de pesos
                </span>
                <span id="weightSum"
                      class="px-3 py-1 rounded-full text-sm font-bold
                             bg-gray-200 text-gray-800 transition">
                    0 / 100
                </span>
            </div>

        </div>

<!-- CONFIDENCE THRESHOLDS -->
<div>
    <h2 class="text-lg font-semibold mb-2">Umbrales de confianza</h2>

    <!-- <p class="text-sm text-gray-500 mb-4 leading-relaxed max-w-md"> -->
    <!-- <p class="text-sm text-gray-500 mb-4 leading-relaxed max-w-md text-justify w-full"> -->
<p class="text-sm text-gray-500 mb-4 leading-relaxed max-w-2xl text-justify">


        Definen el nivel de certeza requerido para clasificar una correlación de fingerprint.
        HIGH exige coincidencias estrictas, MEDIUM un balance operativo y LOW actúa como
        umbral inferior dinámico dependiente de MEDIUM.
    </p>

<!--    <div class="flex items-start gap-6"> -->
        <div class="flex justify-center items-center gap-6">


        <!-- BARRA -->
        <div class="relative h-64 w-4 bg-gradient-to-b from-red-600 via-orange-500 to-green-600 rounded-full">
            <!-- HIGH marker -->
            <div id="markerHigh"
                 class="absolute left-1/2 -translate-x-1/2 w-4 h-4 bg-red-600 border-2 border-white rounded-full">
            </div>

            <!-- MEDIUM marker -->
            <div id="markerMedium"
                 class="absolute left-1/2 -translate-x-1/2 w-4 h-4 bg-orange-500 border-2 border-white rounded-full">
            </div>
        </div>

        <!-- COLUMNA DERECHA -->
        <div class="flex flex-col h-64 w-100 text-sm">

            <!-- MAX -->
            <div class="px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-xs font-semibold text-center">
                MAX · 100
            </div>

            <!-- HIGH -->
            <div class="flex flex-1 items-center gap-2 w-full">
                <span class="w-32 px-2 py-1 rounded bg-red-600 text-white text-xs font-semibold text-center">
                    HIGH
                </span>
                <span>DE</span>
                <input type="number"
                       id="confidenceHigh"
                       name="confidence_high"
                       min="1" max="99"
                       value="{{ fingerprint_policy.confidence_levels.HIGH }}"
                       class="px-2 py-1 border rounded-lg w-16 bg-white dark:bg-gray-900 border-gray-300 dark:border-gray-700">
                <span>A 100</span>
            </div>

            <!-- MEDIUM -->
            <div class="flex flex-1 items-center gap-2 w-full">
                <span class="w-32 px-2 py-1 rounded bg-orange-500 text-white text-xs font-semibold text-center">
                    MEDIUM
                </span>
                <span>DE</span>
                <input type="number"
                       id="confidenceMedium"
                       name="confidence_medium"
                       min="1" max="99"
                       value="{{ fingerprint_policy.confidence_levels.MEDIUM }}"
                       class="px-2 py-1 border rounded-lg w-16 bg-white dark:bg-gray-900 border-gray-300 dark:border-gray-700">
                <span>A <span id="mediumMaxLabel"></span></span>
            </div>

            <!-- LOW -->
            <div class="flex flex-1 items-center gap-2 w-full text-gray-500">
                <span class="w-32 px-2 py-1 rounded bg-green-600 text-white text-xs font-semibold text-center">
                    LOW
                </span>
                <span>DE</span>
                <input type="number"
                       value="0"
                       disabled
                       class="px-2 py-1 border rounded-lg w-16 bg-white dark:bg-gray-900 border-gray-300 dark:border-gray-700">

                <span>A <span id="lowMaxLabel"></span></span>
            </div>

            <!-- MIN -->
            <div class="px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-xs font-semibold text-center">
                MIN · 0
            </div>

        </div>
    </div>
</div>
<script>


const inputHigh = document.getElementById("confidenceHigh");
const inputMedium = document.getElementById("confidenceMedium");

const mediumMaxLabel = document.getElementById("mediumMaxLabel");
const lowMaxLabel = document.getElementById("lowMaxLabel");

// Inicializa los labels al cargar
mediumMaxLabel.textContent = inputHigh.value - 1;
lowMaxLabel.textContent = inputMedium.value - 1;

// Actualiza cuando cambia High
inputHigh.addEventListener("input", () => {
    const highVal = parseInt(inputHigh.value) || 0;
    mediumMaxLabel.textContent = highVal - 1;

    // Asegurar que Medium no pase de High - 1
    if (parseInt(inputMedium.value) >= highVal) {
        inputMedium.value = highVal - 1;
        lowMaxLabel.textContent = inputMedium.value - 1;
    }
});

// Actualiza cuando cambia Medium
inputMedium.addEventListener("input", () => {
    const mediumVal = parseInt(inputMedium.value) || 0;
    lowMaxLabel.textContent = mediumVal - 1;

    // Asegurar que Medium no sobrepase High - 1
    const highVal = parseInt(inputHigh.value) || 0;
    if (mediumVal >= highVal) {
        inputMedium.value = highVal - 1;
        lowMaxLabel.textContent = inputMedium.value - 1;
    }
});



document.addEventListener('DOMContentLoaded', function() {
    const highInput = document.getElementById('confidenceHigh');
    const mediumInput = document.getElementById('confidenceMedium');
    const lowValueText = document.getElementById('lowValueText');
    const mediumMaxLabel = document.getElementById('mediumMaxLabel');
    const lowMaxLabel = document.getElementById('lowMaxLabel');

    function updateLabels() {
        const high = parseInt(highInput.value) || 1;
        const medium = parseInt(mediumInput.value) || 1;

        // Limitar medium a high-1
        const mediumMax = high - 1;
        if(medium > mediumMax) {
            mediumInput.value = mediumMax;
        }

        // LOW máximo = medium-1
        const lowMax = medium - 1;
        lowValueText.textContent = lowMax >= 0 ? lowMax : 0;

        mediumMaxLabel.textContent = mediumMax >= 1 ? mediumMax : 1;
        lowMaxLabel.textContent = lowMax >= 0 ? lowMax : 0;
    }

    highInput.addEventListener('input', updateLabels);
    mediumInput.addEventListener('input', updateLabels);

    // Inicializa al cargar la página
    updateLabels();
});
</script>

<!--&lt;!&ndash; CONFIDENCE THRESHOLDS &ndash;&gt;-->
<!--<div>-->
<!--    <h2 class="text-lg font-semibold mb-2">Umbrales de confianza</h2>-->

<!--    <p class="text-sm text-gray-500 mb-4 leading-relaxed max-w-md">-->
<!--        Definen el nivel de certeza requerido para clasificar una correlación de fingerprint.-->
<!--        HIGH exige coincidencias estrictas, MEDIUM un balance operativo y LOW actúa como-->
<!--        umbral inferior dinámico dependiente de MEDIUM.-->
<!--    </p>-->

<!--    <div class="flex items-start gap-6">-->

<!--        &lt;!&ndash; BARRA &ndash;&gt;-->
<!--        <div class="relative h-64 w-4 bg-gradient-to-b from-red-600 via-orange-500 to-green-600 rounded-full">-->

<!--            <div id="markerHigh"-->
<!--                 class="absolute left-1/2 -translate-x-1/2-->
<!--                        w-4 h-4 bg-red-600 border-2 border-white rounded-full">-->
<!--            </div>-->

<!--            <div id="markerMedium"-->
<!--                 class="absolute left-1/2 -translate-x-1/2-->
<!--                        w-4 h-4 bg-orange-500 border-2 border-white rounded-full">-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; COLUMNA DERECHA &ndash;&gt;-->
<!--        <div class="flex flex-col justify-between h-64 text-sm">-->

<!--            &lt;!&ndash; MAX &ndash;&gt;-->
<!--            <div class="px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-xs font-semibold text-center">-->
<!--                MAX · 100-->
<!--            </div>-->

<!--            &lt;!&ndash; HIGH &ndash;&gt;-->
<!--            <div class="flex items-center justify-between gap-3">-->
<!--                <span class="px-2 py-1 rounded bg-red-600 text-white text-xs font-semibold">-->
<!--                    HIGH-->
<!--                </span> DE-->
<!--                <input type="number"-->
<!--                       id="confidenceHigh"-->
<!--                       name="confidence_high"-->
<!--                       min="1" max="99"-->
<!--                       value="{{ fingerprint_policy.confidence_levels.HIGH }}"-->
<!--                       class="w-20 px-2 py-1 border rounded-lg-->
<!--                              bg-white dark:bg-gray-900-->
<!--                              border-gray-300 dark:border-gray-700"> A 100-->
<!--            </div>-->

<!--            &lt;!&ndash; MEDIUM &ndash;&gt;-->
<!--            <div class="flex items-center justify-between gap-3">-->
<!--                <span class="px-2 py-1 rounded bg-orange-500 text-white text-xs font-semibold">-->
<!--                    MEDIUM-->
<!--                </span> DE-->
<!--                <input type="number"-->
<!--                       id="confidenceMedium"-->
<!--                       name="confidence_medium"-->
<!--                       min="1" max="99"-->
<!--                       value="{{ fingerprint_policy.confidence_levels.MEDIUM }}"-->
<!--                       class="w-20 px-2 py-1 border rounded-lg-->
<!--                              bg-white dark:bg-gray-900-->
<!--                              border-gray-300 dark:border-gray-700"> A <VALOR_DE_HIGH -1>-->
<!--            </div>-->

<!--            &lt;!&ndash; LOW &ndash;&gt;-->
<!--            <div class="flex items-center justify-between gap-3 text-gray-500">-->
<!--                <span class="px-2 py-1 rounded bg-green-600 text-white text-xs font-semibold">-->
<!--                    LOW-->
<!--                </span>DE-->
<!--                <span class="font-mono text-xs">-->
<!--                    0 → <span id="lowValueText"></span>-->
<!--                </span> A <VALOR_DE_MEDIUM - 1>-->
<!--            </div>-->

<!--            &lt;!&ndash; MIN &ndash;&gt;-->
<!--            <div class="px-2 py-1 rounded bg-gray-200 dark:bg-gray-700 text-xs font-semibold text-center">-->
<!--                MIN · 0-->
<!--            </div>-->

<!--        </div>-->
<!--    </div>-->
<!--</div>-->


<!--    <div class="flex gap-6 items-start">-->

<!--        &lt;!&ndash; Barra vertical &ndash;&gt;-->
<!--        <div class="relative h-64 w-6 rounded-full bg-gradient-to-b-->
<!--                    from-red-600 via-orange-500 to-green-600">-->

<!--            &lt;!&ndash; HIGH &ndash;&gt;-->
<!--            <div id="markerHigh"-->
<!--                 class="absolute left-1/2 -translate-x-1/2-->
<!--                        w-5 h-5 rounded-full bg-red-600 border-2 border-white shadow">-->
<!--            </div>-->

<!--            &lt;!&ndash; MEDIUM &ndash;&gt;-->
<!--            <div id="markerMedium"-->
<!--                 class="absolute left-1/2 -translate-x-1/2-->
<!--                        w-5 h-5 rounded-full bg-orange-500 border-2 border-white shadow">-->
<!--            </div>-->

<!--            &lt;!&ndash; LOW &ndash;&gt;-->
<!--            <div id="markerLow"-->
<!--                 class="absolute left-1/2 -translate-x-1/2-->
<!--                        w-5 h-5 rounded-full bg-green-600 border-2 border-white shadow">-->
<!--            </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; Controles numéricos &ndash;&gt;-->
<!--        <div class="space-y-4">-->

<!--            <div class="flex items-center justify-between gap-4">-->
<!--                <span class="px-2 py-1 rounded-full bg-red-600 text-white text-xs font-semibold">-->
<!--                    HIGH-->
<!--                </span>-->
<!--                <input type="number"-->
<!--                       id="confidenceHigh"-->
<!--                       name="confidence_high"-->
<!--                       min="1" max="99"-->
<!--                       value="{{ fingerprint_policy.confidence_levels.HIGH }}"-->
<!--                       class="weight-input w-24 px-2 py-1 border rounded-lg-->
<!--                      bg-white dark:bg-gray-900-->
<!--                      border-gray-300 dark:border-gray-700">-->
<!--            </div>-->

<!--            <div class="flex items-center justify-between gap-4">-->
<!--                <span class="px-2 py-1 rounded-full bg-orange-600 text-white text-xs font-semibold">-->
<!--                    MEDIUM-->
<!--                </span>-->
<!--                <input type="number"-->
<!--                       id="confidenceMedium"-->
<!--                       name="confidence_medium"-->
<!--                       min="1" max="99"-->
<!--                       value="{{ fingerprint_policy.confidence_levels.MEDIUM }}"-->
<!--                       class="weight-input w-24 px-2 py-1 border rounded-lg-->
<!--                      bg-white dark:bg-gray-900-->
<!--                      border-gray-300 dark:border-gray-700">-->
<!--            </div>-->

<!--            <div class="flex items-center justify-between gap-4">-->
<!--                <span class="px-2 py-1 rounded-full bg-green-600 text-white text-xs font-semibold">-->
<!--                    LOW-->
<!--                </span>-->
<!--<input type="number"-->
<!--       id="confidenceLow"-->
<!--       name="confidence_low"-->
<!--       readonly-->
<!--       class="w-24 px-2 py-1 border rounded-lg-->
<!--              bg-gray-100 dark:bg-gray-800-->
<!--              border-gray-300 dark:border-gray-700 cursor-not-allowed">-->

<!--            </div>-->

<!--        </div>-->
<!--    </div>-->
<!--</div>-->

<!--        <div>-->
<!--            <h2 class="text-lg font-semibold mb-3">Umbrales de confianza</h2>-->

<!--            <div class="space-y-3">-->
<!--                <div class="flex items-center justify-between">-->
<!--                    <span class="px-2 py-1 rounded-full bg-red-600 text-white text-xs font-semibold">-->
<!--                        HIGH-->
<!--                    </span>-->
<!--                    <input type="number"-->
<!--                           name="confidence_high"-->
<!--                           value="{{ fingerprint_policy.confidence_levels.HIGH }}"-->
<!--                           min="0" max="100"-->
<!--                           class="w-24 px-2 py-1 border rounded-lg-->
<!--                              bg-white dark:bg-gray-900-->
<!--                              border-gray-300 dark:border-gray-700">-->
<!--                </div>-->

<!--                <div class="flex items-center justify-between">-->
<!--                    <span class="px-2 py-1 rounded-full bg-orange-600 text-white text-xs font-semibold">-->
<!--                        MEDIUM-->
<!--                    </span>-->
<!--                    <input type="number"-->
<!--                           name="confidence_medium"-->
<!--                           value="{{ fingerprint_policy.confidence_levels.MEDIUM }}"-->
<!--                           min="0" max="100"-->
<!--                           class="w-24 px-2 py-1 border rounded-lg-->
<!--                              bg-white dark:bg-gray-900-->
<!--                              border-gray-300 dark:border-gray-700">-->
<!--                </div>-->

<!--                <div class="flex items-center justify-between">-->
<!--                    <span class="px-2 py-1 rounded-full bg-green-600 text-white text-xs font-semibold">-->
<!--                        LOW-->
<!--                    </span>-->
<!--                    <span class="text-sm text-gray-500">-->
<!--                        &lt; MEDIUM-->
<!--                    </span>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->

        <!-- ================= -->
        <!-- ACTIONS -->
        <!-- ================= -->
<div class="md:col-span-2 flex justify-end gap-3 mt-4">


    <button type="submit"
            id="savePolicyBtn"
            class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
            title="La suma de pesos debe ser 100 para guardar">
        Guardar política
    </button>
</div>


    </form>
</div>

<!-- ********************************************************************************* -->

<!-- JS -->
<!-- SCRIPT PARA EL MODAL DE LOS SERVIDORES -->
<script>
function openModalServidor(nombre, ruta) {
    const modal = document.getElementById("editServidorModal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");

    document.getElementById("editServidorNombre").value = nombre;
    document.getElementById("editServidorRuta").value = ruta;
    document.getElementById("editServidorOriginal").value = nombre;

    const form = document.getElementById("editServidorForm");
    form.action = "{{ url_for('configuracion.edit_servidor') }}";
}

function closeServidorModal() {
    const modal = document.getElementById("editServidorModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
}


</script>


<!-- SCRIPT PARA EL MODAL DE LOS TIPOS Y EVENTOS -->
<script>

function openModal(categoria, nombre, color) {
    const modal = document.getElementById("editModal");
    modal.classList.remove("hidden");
    modal.classList.add("flex");

    document.getElementById("editOriginal").value = nombre;
    document.getElementById("editNombre").value = nombre;
    document.getElementById("colorHex").value = color;

    const form = document.getElementById("editForm");
    if (categoria === "tipo") {
        form.action = "{{ url_for('configuracion.route_edit_tipo') }}";
    } else {
        form.action = "{{ url_for('configuracion.route_edit_evento') }}";
    }
}

function closeModal() {
    const modal = document.getElementById("editModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
}

function setColor(c) {
    document.getElementById("colorHex").value = c;
}

// Sincronizar color picker y input HEX
const colorPicker = document.getElementById("editColorPicker");
const colorHex = document.getElementById("editColorHex");

colorPicker.addEventListener("input", () => {
    colorHex.value = colorPicker.value.toUpperCase();
});

colorHex.addEventListener("input", () => {
    const val = colorHex.value.trim();
    if(/^#([0-9A-Fa-f]{6})$/.test(val)) {
        colorPicker.value = val;
    }
});


</script>


<!-- Script para el selector de colores en la edición de un tipo o un evento -->
<script>
    const colorPicker = document.getElementById("editColorPicker");
    const colorHex = document.getElementById("editColorHex");

    // Cuando cambias el color picker, actualiza el input HEX
    colorPicker.addEventListener("input", () => {
        colorHex.value = colorPicker.value.toUpperCase();
    });

    // Cuando cambias el input HEX, actualiza el picker si es un HEX válido
    colorHex.addEventListener("input", () => {
        const val = colorHex.value.trim();
        if(/^#([0-9A-Fa-f]{6})$/.test(val)) {
            colorPicker.value = val;
        }
    });

    // Inicializar valores al abrir el modal
    function openEditModal(nombre, color) {
        document.getElementById("editOriginal").value = nombre;
        document.getElementById("editNombre").value = nombre;
        colorHex.value = color;
        colorPicker.value = color;
        document.getElementById("editModal").classList.remove("hidden");
    }

    function closeModal() {
        document.getElementById("editModal").classList.add("hidden");
    }


</script>

<!-- SCRIPT PARA EL SELECTOR DE PALETA CORPORATIVA -->
<script>
function setColor(c) {
    const hexInput = document.getElementById("colorHex");
    if (hexInput) {
        hexInput.value = c.toUpperCase();
    }

    // Sincronizar el color picker si existe
    const picker = document.getElementById("editColorPicker");
    if (picker) {
        picker.value = c.toUpperCase();
    }
}

</script>
<script>
let selectedColorDiv = null;

function setColor(hex, div) {
    document.getElementById("colorHex").value = hex;

    if (selectedColorDiv) {
        selectedColorDiv.classList.remove("ring-4", "ring-offset-2", "ring-black");
    }

    div.classList.add("ring-4", "ring-offset-2", "ring-black");
    selectedColorDiv = div;
}

</script>

<!-- COntrol de la suma de los pesos (total ha de ser =100) -->
<script>
function updateWeightSum() {
    const inputs = document.querySelectorAll(".weight-input");
    let sum = 0;

    inputs.forEach(i => {
        sum += parseInt(i.value || 0);
    });

    const badge = document.getElementById("weightSum");

    badge.textContent = `${sum} / 100`;

    if (sum === 100) {
        badge.className =
            "px-3 py-1 rounded-full text-sm font-bold bg-green-600 text-white";
        inputs.forEach(i => i.classList.remove("border-red-500"));
    } else {
        badge.className =
            "px-3 py-1 rounded-full text-sm font-bold bg-red-600 text-white";
        inputs.forEach(i => i.classList.add("border-red-500"));
    }
}

document.querySelectorAll(".weight-input").forEach(input => {
    input.addEventListener("input", updateWeightSum);
});

// Inicializar al cargar
updateWeightSum();
</script>
<script>
// Mapa de presets: suman 100
const presets = {
    equilibrado:      {visitorId: 40, platform: 10, browser: 10, timezone: 10, deviceMemory: 10, screenResolution: 20},
    agresivo:    {visitorId: 60, platform: 5,  browser: 5,  timezone: 10, deviceMemory: 10, screenResolution: 10},
    relajado:  {visitorId: 20, platform: 15, browser: 15, timezone: 10, deviceMemory: 10, screenResolution: 30}
};

function applyPreset(name) {
    const preset = presets[name];
    if (!preset) return;

    for (const key in preset) {
        const input = document.querySelector(`input[name="check_${key}"]`);
        if (input) input.value = preset[key];
    }

    updateWeightSum();
}

function updateWeightSum() {
    const inputs = document.querySelectorAll(".weight-input");
    let sum = 0;

    inputs.forEach(i => {
        sum += parseInt(i.value || 0);
    });

    const badge = document.getElementById("weightSum");
    const saveBtn = document.getElementById("savePolicyBtn");

    badge.textContent = `${sum} / 100`;

    if (sum === 100) {
        badge.className = "px-3 py-1 rounded-full text-sm font-bold bg-green-600 text-white";
        inputs.forEach(i => i.classList.remove("border-red-500"));
        saveBtn.disabled = false;
    } else {
        badge.className = "px-3 py-1 rounded-full text-sm font-bold bg-red-600 text-white";
        inputs.forEach(i => i.classList.add("border-red-500"));
        saveBtn.disabled = true;
    }
}

// Inicializar al cargar
updateWeightSum();

// Escuchar cambios en todos los inputs
document.querySelectorAll(".weight-input").forEach(input => {
    input.addEventListener("input", updateWeightSum);
});
</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    function updateWeightsUI() {
        const inputs = document.querySelectorAll(".weight-input");
        let sum = 0;

        inputs.forEach(input => {
            const current = parseInt(input.value || 0);
            const original = parseInt(input.dataset.original);
            const key = input.dataset.key;
            const delta = current - original;

            sum += current;

            const deltaSpan = document.getElementById(`delta_${key}`);

            if (delta === 0) {
                deltaSpan.textContent = "";
                deltaSpan.classList.add("hidden");
            } else {
                deltaSpan.textContent = (delta > 0 ? "+" : "") + delta;
                deltaSpan.classList.remove("hidden");
                deltaSpan.classList.remove("text-green-600");
                deltaSpan.classList.add("text-red-600");
            }
        });

        const badge = document.getElementById("weightSum");
        const saveBtn = document.getElementById("savePolicyBtn");

        badge.textContent = `${sum} / 100`;

        if (sum === 100) {
            badge.className = "px-3 py-1 rounded-full text-sm font-bold bg-green-600 text-white";
            inputs.forEach(i => i.classList.remove("border-red-500"));
            saveBtn.disabled = false;
        } else {
            badge.className = "px-3 py-1 rounded-full text-sm font-bold bg-red-600 text-white";
            inputs.forEach(i => i.classList.add("border-red-500"));
            saveBtn.disabled = true;
        }
    }

    // Listener inputs
    document.querySelectorAll(".weight-input").forEach(input => {
        input.addEventListener("input", updateWeightsUI);
    });

    // Botón RESTABLECER (funcional)
    const resetBtn = document.getElementById("resetPolicyBtn");
    resetBtn.addEventListener("click", () => {
        document.querySelectorAll(".weight-input").forEach(input => {
            input.value = input.dataset.original;
        });
        updateWeightsUI();
    });

    // Inicializar estado visual
    updateWeightsUI();
});
</script>

<script>
const barHeight = 256; // px

const highInput = document.getElementById("confidenceHigh");
const mediumInput = document.getElementById("confidenceMedium");
const lowValue = 1;

const markerHigh = document.getElementById("markerHigh");
const markerMedium = document.getElementById("markerMedium");
const markerLow = document.getElementById("markerLow");

const markerSize = 20; // px (h-5)

function valueToPosition(value) {
    const raw = barHeight - (value / 100) * barHeight;
    return Math.min(
        barHeight - markerSize / 2,
        Math.max(-markerSize / 2, raw)
    );
}


function clampThresholds() {
    let high = Math.min(99, Math.max(2, parseInt(highInput.value)));
    let medium = Math.min(high - 1, Math.max(lowValue + 1, parseInt(mediumInput.value)));

    highInput.value = high;
    mediumInput.value = medium;
}

function updateMarkers() {
    clampThresholds();

    const high = parseInt(highInput.value);
    const medium = parseInt(mediumInput.value);

    markerHigh.style.top = valueToPosition(high) + "px";
    markerMedium.style.top = valueToPosition(medium) + "px";
    markerLow.style.top = valueToPosition(lowValue) + "px";
}

highInput.addEventListener("input", updateMarkers);
mediumInput.addEventListener("input", updateMarkers);

updateMarkers();

function valueToPercent(value) {
    return 100 - Math.max(0, Math.min(100, value));
}


function moveMarker(marker, value) {
    marker.style.top = `${valueToPercent(value)}%`;
}


function enforceThresholdRules() {
    let high = parseInt(confidenceHigh.value);
    let medium = parseInt(confidenceMedium.value);

    if (high > 99) high = 99;
    if (medium < 1) medium = 1;

    if (medium >= high) {
        medium = high - 1;
    }

    confidenceHigh.value = high;
    confidenceMedium.value = medium;

    moveMarker(markerHigh, high);
    moveMarker(markerMedium, medium);

    // LOW dinámico
    document.getElementById("lowRangeLabel").textContent = medium - 1;
}

confidenceHigh.addEventListener("input", enforceThresholdRules);
confidenceMedium.addEventListener("input", enforceThresholdRules);

document.addEventListener("DOMContentLoaded", enforceThresholdRules);

document.getElementById("lowValueText").textContent = medium - 1;

</script>

<script>
document.addEventListener("DOMContentLoaded", () => {

    const highInput = document.getElementById("confidenceHigh");
    const mediumInput = document.getElementById("confidenceMedium");

    const mediumMaxSpan = document.getElementById("mediumMaxValue");
    const lowMaxSpan = document.getElementById("lowMaxValue");
    const lowValueText = document.getElementById("lowValueText");

    function recalcRanges() {
        let high = parseInt(highInput.value, 10);
        let medium = parseInt(mediumInput.value, 10);

        // Hard guardrails
        if (medium >= high) {
            medium = high - 1;
            mediumInput.value = medium;
        }

        if (medium < 1) {
            medium = 1;
            mediumInput.value = medium;
        }

        // MEDIUM range
        mediumMaxSpan.textContent = high - 1;

        // LOW range
        lowMaxSpan.textContent = medium - 1;
        lowValueText.textContent = medium - 1;
    }

    highInput.addEventListener("input", recalcRanges);
    mediumInput.addEventListener("input", recalcRanges);

    // Initial sync
    recalcRanges();
});
</script>


{% endblock %}

